# 🚀 实际支付流程测试指南

## 📋 测试环境信息

- **主应用地址**：http://localhost:3002/
- **测试回调页面**：http://localhost:3002/test-callback-server.html
- **同步回调地址**：http://localhost:3002/payment/callback
- **异步回调地址**：http://localhost:3002/test-callback-server.html
- **通讯密钥**：f659709e38ab01a9d77e52cdcda9a914

## 🔧 蓝鲸支付后台配置

### 1. 登录蓝鲸支付后台
访问蓝鲸支付管理后台，使用您的商户账号登录。

### 2. 配置回调地址
在"商户设置"或"回调配置"页面中填写：

```
同步回调地址（returnUrl）：
http://localhost:3002/payment/callback

异步回调地址（notifyUrl）：
http://localhost:3002/test-callback-server.html

通讯密钥：
f659709e38ab01a9d77e52cdcda9a914
```

### 3. 保存配置
点击"保存"或"更新"按钮，确保配置生效。

## 🧪 测试步骤

### 第一步：打开主应用
1. 访问：http://localhost:3002/
2. 填写测试信息：
   - 姓名：测试用户
   - 出生日期：1990-01-01
3. 点击"生成报告"

### 第二步：发起支付
1. 在报告页面点击"立即支付"按钮
2. 选择支付方式：
   - 微信支付（type=1）
   - 支付宝支付（type=2）
3. 点击"生成蓝鲸支付二维码"

### 第三步：完成支付
1. 使用手机扫描生成的二维码
2. 在蓝鲸支付页面完成支付
3. 支付成功后会自动跳转

### 第四步：验证回调
1. 支付完成后会跳转到回调页面
2. 检查回调参数：
   - 订单号（payId）
   - 商品描述（param）
   - 支付方式（type）
   - 订单金额（price）
   - 实际支付金额（reallyPrice）
   - 签名（sign）

### 第五步：验证签名
回调页面会自动验证签名：
- 签名字符串：`payId + param + type + price + reallyPrice + appSecret`
- 使用MD5算法计算签名
- 与接收到的签名进行对比

## 🔍 测试验证点

### 1. 支付订单创建
- ✅ 订单号生成成功
- ✅ 签名计算正确
- ✅ API调用成功
- ✅ 二维码生成成功

### 2. 支付完成回调
- ✅ 同步回调接收成功
- ✅ 异步回调接收成功
- ✅ 签名验证通过
- ✅ 支付状态更新

### 3. 错误处理
- ✅ 网络错误处理
- ✅ 签名错误处理
- ✅ 参数错误处理

## 🐛 常见问题排查

### 问题1：订单创建失败
**可能原因：**
- 签名计算错误
- 参数格式不正确
- 网络连接问题

**解决方法：**
1. 检查签名计算逻辑
2. 验证参数类型和格式
3. 检查网络连接

### 问题2：回调接收失败
**可能原因：**
- 回调地址配置错误
- 本地服务器未启动
- 防火墙阻止访问

**解决方法：**
1. 确认回调地址正确
2. 确保本地服务器运行
3. 检查防火墙设置

### 问题3：签名验证失败
**可能原因：**
- 签名字符串拼接错误
- 字符编码问题
- 通讯密钥错误

**解决方法：**
1. 检查签名字符串拼接顺序
2. 确保使用UTF-8编码
3. 验证通讯密钥正确

## 📊 测试数据示例

### 测试订单参数
```javascript
{
  payId: "TEST_ORDER_" + Date.now(),
  param: "玄学命理分析报告",
  type: "1", // 1=微信支付, 2=支付宝支付
  price: "9.99",
  reallyPrice: "9.99",
  appSecret: "f659709e38ab01a9d77e52cdcda9a914"
}
```

### 签名字符串示例
```
TEST_ORDER_1703123456789玄学命理分析报告19.999.99f659709e38ab01a9d77e52cdcda9a914
```

### 预期签名结果
```
计算出的32位小写MD5哈希值
```

## 🎯 测试成功标准

1. **支付流程完整**：从订单创建到支付完成
2. **回调接收正常**：同步和异步回调都能正确接收
3. **签名验证通过**：所有签名验证都成功
4. **状态更新及时**：支付状态能够及时更新
5. **错误处理完善**：各种异常情况都能正确处理

## 📝 测试记录

请在测试过程中记录以下信息：

- [ ] 订单创建成功
- [ ] 二维码生成成功
- [ ] 支付完成
- [ ] 同步回调接收
- [ ] 异步回调接收
- [ ] 签名验证通过
- [ ] 支付状态更新
- [ ] 错误处理正常

## 🔄 下一步

测试完成后，如果一切正常，可以：
1. 部署到生产环境（Netlify）
2. 更新生产环境的回调地址
3. 进行生产环境测试
4. 正式上线使用

---

**注意**：这是本地测试环境，仅用于开发和测试。生产环境需要使用HTTPS地址和正式的域名。
