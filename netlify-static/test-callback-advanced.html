<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付回调测试工具 - 高级版</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>支付回调测试工具 - 高级版</h1>
        
        <div class="test-section">
            <h3>1. 回调地址状态检查</h3>
            <p>检查Netlify Function是否正常运行</p>
            <button class="test-button" onclick="checkCallbackStatus()">检查回调状态</button>
            <div id="statusResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. 模拟支付回调测试</h3>
            <p>使用真实参数模拟支付平台回调</p>
            
            <div class="form-group">
                <label for="testPayId">商户订单号:</label>
                <input type="text" id="testPayId" value="TEST_ORDER_1234567890" placeholder="输入订单号">
            </div>
            
            <div class="form-group">
                <label for="testParam">商品描述:</label>
                <input type="text" id="testParam" value="玄学命理分析报告" placeholder="输入商品描述">
            </div>
            
            <div class="form-group">
                <label for="testType">支付方式:</label>
                <select id="testType">
                    <option value="1">微信支付</option>
                    <option value="2">支付宝支付</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="testPrice">订单金额:</label>
                <input type="text" id="testPrice" value="9.99" placeholder="输入金额">
            </div>
            
            <div class="form-group">
                <label for="testReallyPrice">实际支付金额:</label>
                <input type="text" id="testReallyPrice" value="9.99" placeholder="输入实际金额">
            </div>
            
            <button class="test-button" onclick="testCallback()">测试回调</button>
            <button class="test-button success" onclick="testCallbackWithRealData()">使用真实数据测试</button>
            <div id="callbackResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. 签名验证测试</h3>
            <p>验证签名计算是否正确</p>
            <button class="test-button" onclick="testSignature()">测试签名计算</button>
            <div id="signatureResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. 批量测试</h3>
            <p>测试多个订单的回调处理</p>
            <button class="test-button" onclick="batchTest()">批量测试</button>
            <div id="batchResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. 当前配置信息</h3>
            <div id="configInfo" class="result info"></div>
        </div>
    </div>

    <script>
        // 当前配置
        const config = {
            asyncCallbackUrl: 'https://spontaneous-haupia-55e958.netlify.app/.netlify/functions/payment-callback',
            syncCallbackUrl: 'https://spontaneous-haupia-55e958.netlify.app/payment/callback',
            appSecret: 'f659709e38ab01a9d77e52cdcda9a914'
        };

        // 显示配置信息
        document.getElementById('configInfo').textContent = 
            `异步回调地址: ${config.asyncCallbackUrl}\n` +
            `同步回调地址: ${config.syncCallbackUrl}\n` +
            `通讯密钥: ${config.appSecret}\n` +
            `测试时间: ${new Date().toLocaleString()}`;

        // 检查回调状态
        async function checkCallbackStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.textContent = '正在检查回调状态...';
            resultDiv.className = 'result info';

            try {
                const response = await fetch(config.asyncCallbackUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain'
                    }
                });

                const responseText = await response.text();
                
                if (response.ok) {
                    resultDiv.textContent = `✅ 回调地址正常！\n状态码: ${response.status}\n响应: ${responseText}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `❌ 回调地址异常！\n状态码: ${response.status}\n响应: ${responseText}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `❌ 检查失败：${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 测试回调
        async function testCallback() {
            const resultDiv = document.getElementById('callbackResult');
            resultDiv.textContent = '正在测试回调...';
            resultDiv.className = 'result info';

            try {
                const payId = document.getElementById('testPayId').value;
                const param = document.getElementById('testParam').value;
                const type = document.getElementById('testType').value;
                const price = document.getElementById('testPrice').value;
                const reallyPrice = document.getElementById('testReallyPrice').value;

                const sign = calculateSignature(payId, param, type, price, reallyPrice);

                const testParams = {
                    payId,
                    param,
                    type,
                    price,
                    reallyPrice,
                    sign
                };

                const queryString = new URLSearchParams(testParams).toString();
                const testUrl = `${config.asyncCallbackUrl}?${queryString}`;

                console.log('测试URL:', testUrl);
                console.log('测试参数:', testParams);

                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain'
                    }
                });

                const responseText = await response.text();
                
                if (response.ok && responseText === 'success') {
                    resultDiv.textContent = `✅ 回调测试成功！\n状态码: ${response.status}\n响应: ${responseText}\n订单号: ${payId}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `❌ 回调测试失败！\n状态码: ${response.status}\n响应: ${responseText}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `❌ 回调测试出错：${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 使用真实数据测试
        async function testCallbackWithRealData() {
            const resultDiv = document.getElementById('callbackResult');
            resultDiv.textContent = '正在使用真实数据测试...';
            resultDiv.className = 'result info';

            try {
                // 使用真实的支付数据
                const payId = 'ORDER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const param = '玄学命理分析报告';
                const type = '1';
                const price = '9.99';
                const reallyPrice = '9.99';

                const sign = calculateSignature(payId, param, type, price, reallyPrice);

                const testParams = {
                    payId,
                    param,
                    type,
                    price,
                    reallyPrice,
                    sign
                };

                const queryString = new URLSearchParams(testParams).toString();
                const testUrl = `${config.asyncCallbackUrl}?${queryString}`;

                console.log('真实数据测试URL:', testUrl);
                console.log('真实数据测试参数:', testParams);

                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain'
                    }
                });

                const responseText = await response.text();
                
                if (response.ok && responseText === 'success') {
                    resultDiv.textContent = `✅ 真实数据回调测试成功！\n状态码: ${response.status}\n响应: ${responseText}\n订单号: ${payId}\n时间: ${new Date().toLocaleString()}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `❌ 真实数据回调测试失败！\n状态码: ${response.status}\n响应: ${responseText}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `❌ 真实数据回调测试出错：${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 测试签名计算
        function testSignature() {
            const resultDiv = document.getElementById('signatureResult');
            
            // 使用示例数据测试签名
            const payId = '1547130349673';
            const param = 'vone666';
            const type = '2';
            const price = '0.1';
            const reallyPrice = '0.1';
            const expectedSign = '28943820b95019b6a63598a13c46f93f';

            const calculatedSign = calculateSignature(payId, param, type, price, reallyPrice);
            const isMatch = calculatedSign === expectedSign;

            resultDiv.textContent = 
                `测试数据:\n` +
                `payId: ${payId}\n` +
                `param: ${param}\n` +
                `type: ${type}\n` +
                `price: ${price}\n` +
                `reallyPrice: ${reallyPrice}\n` +
                `\n期望签名: ${expectedSign}\n` +
                `计算签名: ${calculatedSign}\n` +
                `匹配结果: ${isMatch ? '✅ 正确' : '❌ 错误'}`;
            
            resultDiv.className = `result ${isMatch ? 'success' : 'error'}`;
        }

        // 批量测试
        async function batchTest() {
            const resultDiv = document.getElementById('batchResult');
            resultDiv.textContent = '正在执行批量测试...';
            resultDiv.className = 'result info';

            const results = [];
            const testCount = 5;

            for (let i = 0; i < testCount; i++) {
                try {
                    const payId = `BATCH_TEST_${Date.now()}_${i}`;
                    const param = '批量测试商品';
                    const type = '1';
                    const price = '9.99';
                    const reallyPrice = '9.99';

                    const sign = calculateSignature(payId, param, type, price, reallyPrice);

                    const testParams = {
                        payId,
                        param,
                        type,
                        price,
                        reallyPrice,
                        sign
                    };

                    const queryString = new URLSearchParams(testParams).toString();
                    const testUrl = `${config.asyncCallbackUrl}?${queryString}`;

                    const response = await fetch(testUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/plain'
                        }
                    });

                    const responseText = await response.text();
                    const success = response.ok && responseText === 'success';
                    
                    results.push({
                        orderId: payId,
                        success: success,
                        status: response.status,
                        response: responseText
                    });

                    // 添加延迟避免过快请求
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    results.push({
                        orderId: `BATCH_TEST_${i}`,
                        success: false,
                        error: error.message
                    });
                }
            }

            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;

            resultDiv.textContent = 
                `批量测试完成！\n` +
                `总测试数: ${results.length}\n` +
                `成功: ${successCount}\n` +
                `失败: ${failCount}\n` +
                `\n详细结果:\n` +
                results.map(r => 
                    `${r.success ? '✅' : '❌'} ${r.orderId}: ${r.success ? '成功' : (r.error || `状态码${r.status}`)}`
                ).join('\n');
            
            resultDiv.className = `result ${failCount === 0 ? 'success' : 'warning'}`;
        }

        // 计算签名
        function calculateSignature(payId, param, type, price, reallyPrice) {
            const signString = `${payId}${param}${type}${price}${reallyPrice}${config.appSecret}`;
            return md5(signString);
        }

        // 简单的MD5实现
        function md5(string) {
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17, 606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12, 1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7, 1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7, 1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22, 1236535329);
                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14, 643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9, 38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5, 568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20, 1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14, 1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);
                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16, 1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11, 1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4, 681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23, 76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16, 530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);
                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10, 1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6, 1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6, 1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21, 1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15, 718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);
                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            }
            function cmn(q, a, b, x, s, t) {
                a = add32(add32(a, q), add32(x, t));
                return add32((a << s) | (a >>> (32 - s)), b);
            }
            function ff(a, b, c, d, x, s, t) {
                return cmn((b & c) | ((~b) & d), a, b, x, s, t);
            }
            function gg(a, b, c, d, x, s, t) {
                return cmn((b & d) | (c & (~d)), a, b, x, s, t);
            }
            function hh(a, b, c, d, x, s, t) {
                return cmn(b ^ c ^ d, a, b, x, s, t);
            }
            function ii(a, b, c, d, x, s, t) {
                return cmn(c ^ (b | (~d)), a, b, x, s, t);
            }
            function md5cmn(q, a, b, x, s, t) {
                a = add32(add32(a, q), add32(x, t));
                return add32((a << s) | (a >>> (32 - s)), b);
            }
            function md5ff(a, b, c, d, x, s, t) {
                return md5cmn((b & c) | ((~b) & d), a, b, x, s, t);
            }
            function md5gg(a, b, c, d, x, s, t) {
                return md5cmn((b & d) | (c & (~d)), a, b, x, s, t);
            }
            function md5hh(a, b, c, d, x, s, t) {
                return md5cmn(b ^ c ^ d, a, b, x, s, t);
            }
            function md5ii(a, b, c, d, x, s, t) {
                return md5cmn(c ^ (b | (~d)), a, b, x, s, t);
            }
            function add32(a, b) {
                return (a + b) & 0xFFFFFFFF;
            }
            function rhex(n) {
                var s = '', j = 0;
                for (; j < 4; j++)
                    s += hex_chr[(n >> (j * 8 + 4)) & 0x0F]
                        + hex_chr[(n >> (j * 8)) & 0x0F];
                return s;
            }
            function hex(x) {
                for (var i = 0; i < x.length; i++)
                    x[i] = rhex(x[i]);
                return x.join('');
            }
            var hex_chr = '0123456789abcdef'.split('');
            function md5(s) {
                return hex(md5core(s));
            }
            function md5core(s) {
                var n = s.length,
                    state = [1732584193, -271733879, -1732584194, 271733878], i;
                for (i = 64; i <= s.length; i += 64) {
                    md5cycle(state, md5blk(s.substring(i - 64, i)));
                }
                s = s.substring(i - 64);
                var tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                for (i = 0; i < s.length; i++)
                    tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
                tail[i >> 2] |= 0x80 << ((i % 4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    for (i = 0; i < 16; i++) tail[i] = 0;
                }
                tail[14] = n * 8;
                md5cycle(state, tail);
                return state;
            }
            function md5blk(s) {
                var md5blks = [], i;
                for (i = 0; i < 64; i += 4) {
                    md5blks[i >> 2] = s.charCodeAt(i)
                        + (s.charCodeAt(i + 1) << 8)
                        + (s.charCodeAt(i + 2) << 16)
                        + (s.charCodeAt(i + 3) << 24);
                }
                return md5blks;
            }
            return md5(string);
        }
    </script>
</body>
</html>
