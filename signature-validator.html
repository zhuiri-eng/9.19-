<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾åéªŒè¯å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .validator-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; margin: 10px 0; }
        .url-display { word-break: break-all; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 5px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ” ç­¾åéªŒè¯å™¨</h1>
    
    <div class="validator-section">
        <h3>ğŸ“ æ‰‹åŠ¨æµ‹è¯•</h3>
        <div class="test-form">
            <div class="form-group">
                <label>å•†æˆ·è®¢å•å· (payId):</label>
                <input type="text" id="payId" value="TEST_1234567890">
            </div>
            <div class="form-group">
                <label>å•†å“æè¿° (param):</label>
                <input type="text" id="param" value="æµ‹è¯•å•†å“">
            </div>
            <div class="form-group">
                <label>æ”¯ä»˜ç±»å‹ (type):</label>
                <input type="text" id="type" value="1">
            </div>
            <div class="form-group">
                <label>è®¢å•é‡‘é¢ (price):</label>
                <input type="text" id="price" value="0.01">
            </div>
            <div class="form-group">
                <label>å®é™…æ”¯ä»˜é‡‘é¢ (reallyPrice):</label>
                <input type="text" id="reallyPrice" value="0.01">
            </div>
            <div class="form-group">
                <label>é€šè®¯å¯†é’¥ (appSecret):</label>
                <input type="text" id="appSecret" value="f659709e38ab01a9d77e52cdcda9a914" readonly>
            </div>
            <button onclick="calculateAndTest()">è®¡ç®—ç­¾åå¹¶æµ‹è¯•</button>
        </div>
    </div>

    <div class="validator-section">
        <h3>ğŸ” ç­¾åå¯¹æ¯”</h3>
        <div class="comparison">
            <div>
                <h4>å‰ç«¯è®¡ç®— (CryptoJS)</h4>
                <div class="code-block" id="frontendResult">ç‚¹å‡»"è®¡ç®—ç­¾åå¹¶æµ‹è¯•"æŸ¥çœ‹ç»“æœ</div>
            </div>
            <div>
                <h4>åç«¯è®¡ç®— (Node.js crypto)</h4>
                <div class="code-block" id="backendResult">ç‚¹å‡»"è®¡ç®—ç­¾åå¹¶æµ‹è¯•"æŸ¥çœ‹ç»“æœ</div>
            </div>
        </div>
    </div>

    <div class="validator-section">
        <h3>ğŸŒ å®é™…æµ‹è¯•</h3>
        <div id="actualTestResult">
            <div class="url-display" id="testUrl">ç‚¹å‡»"è®¡ç®—ç­¾åå¹¶æµ‹è¯•"ç”Ÿæˆæµ‹è¯•URL</div>
            <button onclick="testCallback()">æµ‹è¯•å›è°ƒ</button>
        </div>
    </div>

    <div class="validator-section">
        <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="debugLog" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="validator-section">
        <h3>ğŸ§ª é¢„è®¾æµ‹è¯•ç”¨ä¾‹</h3>
        <button onclick="testCase1()">æµ‹è¯•ç”¨ä¾‹1: è‹±æ–‡</button>
        <button onclick="testCase2()">æµ‹è¯•ç”¨ä¾‹2: ä¸­æ–‡</button>
        <button onclick="testCase3()">æµ‹è¯•ç”¨ä¾‹3: ç‰¹æ®Šå­—ç¬¦</button>
    </div>

    <script>
        const appSecret = 'f659709e38ab01a9d77e52cdcda9a914';
        const baseUrl = 'https://phenomenal-meerkat-53edff.netlify.app';

        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        function calculateSignature(payId, param, type, price, reallyPrice) {
            const signString = `${payId}${param}${type}${price}${reallyPrice}${appSecret}`;
            const signature = CryptoJS.MD5(signString).toString();
            return { signString, signature };
        }

        function calculateAndTest() {
            const payId = document.getElementById('payId').value;
            const param = document.getElementById('param').value;
            const type = document.getElementById('type').value;
            const price = document.getElementById('price').value;
            const reallyPrice = document.getElementById('reallyPrice').value;

            log('=== å¼€å§‹ç­¾åè®¡ç®— ===');
            log(`è¾“å…¥å‚æ•°:`);
            log(`  payId: "${payId}"`);
            log(`  param: "${param}"`);
            log(`  type: "${type}"`);
            log(`  price: "${price}"`);
            log(`  reallyPrice: "${reallyPrice}"`);
            log(`  appSecret: "${appSecret}"`);

            const { signString, signature } = calculateSignature(payId, param, type, price, reallyPrice);

            // æ˜¾ç¤ºå‰ç«¯è®¡ç®—ç»“æœ
            document.getElementById('frontendResult').textContent = `
ç­¾åå­—ç¬¦ä¸²:
"${signString}"

MD5ç­¾å:
"${signature}"

å­—ç¬¦é•¿åº¦: ${signString.length}
ç­¾åé•¿åº¦: ${signature.length}
            `;

            // æ˜¾ç¤ºåç«¯è®¡ç®—ç»“æœï¼ˆæ¨¡æ‹ŸNode.js cryptoï¼‰
            const backendSignString = `${payId}${param}${type}${price}${reallyPrice}${appSecret}`;
            const backendSignature = CryptoJS.MD5(backendSignString).toString();
            
            document.getElementById('backendResult').textContent = `
ç­¾åå­—ç¬¦ä¸²:
"${backendSignString}"

MD5ç­¾å:
"${backendSignature}"

å­—ç¬¦é•¿åº¦: ${backendSignString.length}
ç­¾åé•¿åº¦: ${backendSignature.length}
            `;

            // ç”Ÿæˆæµ‹è¯•URL
            const testUrl = `${baseUrl}/.netlify/functions/payment-callback?payId=${encodeURIComponent(payId)}&param=${encodeURIComponent(param)}&type=${type}&price=${price}&reallyPrice=${reallyPrice}&sign=${signature}`;
            document.getElementById('testUrl').textContent = testUrl;

            log(`ç­¾åå­—ç¬¦ä¸²: "${signString}"`);
            log(`è®¡ç®—ç­¾å: "${signature}"`);
            log(`æµ‹è¯•URLå·²ç”Ÿæˆ`);

            // æ£€æŸ¥ç­¾åæ˜¯å¦ä¸€è‡´
            if (signString === backendSignString && signature === backendSignature) {
                log('âœ… å‰ç«¯å’Œåç«¯ç­¾åè®¡ç®—ä¸€è‡´');
            } else {
                log('âŒ å‰ç«¯å’Œåç«¯ç­¾åè®¡ç®—ä¸ä¸€è‡´');
            }
        }

        async function testCallback() {
            const payId = document.getElementById('payId').value;
            const param = document.getElementById('param').value;
            const type = document.getElementById('type').value;
            const price = document.getElementById('price').value;
            const reallyPrice = document.getElementById('reallyPrice').value;

            const { signature } = calculateSignature(payId, param, type, price, reallyPrice);
            const testUrl = `${baseUrl}/.netlify/functions/payment-callback?payId=${encodeURIComponent(payId)}&param=${encodeURIComponent(param)}&type=${type}&price=${price}&reallyPrice=${reallyPrice}&sign=${signature}`;

            log('=== å¼€å§‹å›è°ƒæµ‹è¯• ===');
            log(`æµ‹è¯•URL: ${testUrl}`);

            try {
                const response = await fetch(testUrl);
                const responseText = await response.text();

                log(`å“åº”çŠ¶æ€: ${response.status}`);
                log(`å“åº”å†…å®¹: ${responseText}`);

                if (response.ok && responseText.includes('success')) {
                    log('âœ… å›è°ƒæµ‹è¯•æˆåŠŸï¼');
                } else if (responseText.includes('error_sign')) {
                    log('âŒ ç­¾åéªŒè¯å¤±è´¥ - error_sign');
                    log('å¯èƒ½åŸå› :');
                    log('1. ç­¾åå­—ç¬¦ä¸²æ‹¼æ¥é¡ºåºé”™è¯¯');
                    log('2. å‚æ•°ç±»å‹ä¸åŒ¹é…');
                    log('3. å­—ç¬¦ç¼–ç é—®é¢˜');
                    log('4. é€šè®¯å¯†é’¥é”™è¯¯');
                } else if (responseText.includes('error_params')) {
                    log('âŒ å‚æ•°éªŒè¯å¤±è´¥ - error_params');
                } else {
                    log(`âŒ å…¶ä»–é”™è¯¯: ${responseText}`);
                }

            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        function testCase1() {
            document.getElementById('payId').value = 'TEST_ENGLISH_123';
            document.getElementById('param').value = 'English Product';
            document.getElementById('type').value = '1';
            document.getElementById('price').value = '1.00';
            document.getElementById('reallyPrice').value = '1.00';
            calculateAndTest();
            log('=== æµ‹è¯•ç”¨ä¾‹1: è‹±æ–‡å‚æ•° ===');
        }

        function testCase2() {
            document.getElementById('payId').value = 'TEST_ä¸­æ–‡_456';
            document.getElementById('param').value = 'ä¸­æ–‡å•†å“';
            document.getElementById('type').value = '2';
            document.getElementById('price').value = '9.99';
            document.getElementById('reallyPrice').value = '9.99';
            calculateAndTest();
            log('=== æµ‹è¯•ç”¨ä¾‹2: ä¸­æ–‡å‚æ•° ===');
        }

        function testCase3() {
            document.getElementById('payId').value = 'TEST_SPECIAL_789';
            document.getElementById('param').value = 'ç‰¹æ®Šå­—ç¬¦!@#$%^&*()';
            document.getElementById('type').value = '1';
            document.getElementById('price').value = '0.01';
            document.getElementById('reallyPrice').value = '0.01';
            calculateAndTest();
            log('=== æµ‹è¯•ç”¨ä¾‹3: ç‰¹æ®Šå­—ç¬¦ ===');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è®¡ç®—ä¸€æ¬¡
        window.onload = function() {
            log('ç­¾åéªŒè¯å™¨å·²åŠ è½½');
            calculateAndTest();
        };
    </script>
</body>
</html>
