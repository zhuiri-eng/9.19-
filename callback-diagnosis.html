<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›è°ƒè¯Šæ–­å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .diagnosis-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .info { background: #e2e3e5; color: #383d41; padding: 15px; border-radius: 8px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .url-display { word-break: break-all; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ğŸ” å›è°ƒè¯Šæ–­å·¥å…·</h1>
    
    <div class="diagnosis-section">
        <h3>ğŸ“‹ å½“å‰é…ç½®ä¿¡æ¯</h3>
        <div class="info">
            <p><strong>ç½‘ç«™åœ°å€ï¼š</strong>https://phenomenal-meerkat-53edff.netlify.app</p>
            <p><strong>åŒæ­¥å›è°ƒåœ°å€ï¼š</strong>https://phenomenal-meerkat-53edff.netlify.app/callback</p>
            <p><strong>å¼‚æ­¥å›è°ƒåœ°å€ï¼š</strong>https://phenomenal-meerkat-53edff.netlify.app/.netlify/functions/payment-callback</p>
            <p><strong>é€šè®¯å¯†é’¥ï¼š</strong>f659709e38ab01a9d77e52cdcda9a914</p>
        </div>
    </div>

    <div class="diagnosis-section">
        <h3>ğŸ”§ è¯Šæ–­æ­¥éª¤</h3>
        <div class="step">
            <h4>æ­¥éª¤1ï¼šæµ‹è¯•åŸºç¡€è¿é€šæ€§</h4>
            <button onclick="testBasicConnectivity()">æµ‹è¯•åŸºç¡€è¿é€šæ€§</button>
        </div>
        <div class="step">
            <h4>æ­¥éª¤2ï¼šæµ‹è¯• Netlify Functions</h4>
            <button onclick="testNetlifyFunctions()">æµ‹è¯• Netlify Functions</button>
        </div>
        <div class="step">
            <h4>æ­¥éª¤3ï¼šæµ‹è¯•å›è°ƒé‡å®šå‘</h4>
            <button onclick="testCallbackRedirects()">æµ‹è¯•å›è°ƒé‡å®šå‘</button>
        </div>
        <div class="step">
            <h4>æ­¥éª¤4ï¼šæµ‹è¯•å®Œæ•´å›è°ƒæµç¨‹</h4>
            <button onclick="testFullCallbackFlow()">æµ‹è¯•å®Œæ•´å›è°ƒæµç¨‹</button>
        </div>
        <div class="step">
            <h4>æ­¥éª¤5ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡</h4>
            <button onclick="checkEnvironmentVariables()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
        </div>
        <div id="diagnosisResult" class="diagnosis-section" style="display: none;"></div>
    </div>

    <div class="diagnosis-section">
        <h3>ğŸ“ è¯Šæ–­æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="diagnosisLog" class="log">ç­‰å¾…è¯Šæ–­...</div>
    </div>

    <div class="diagnosis-section">
        <h3>ğŸ› ï¸ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
        <div class="info">
            <h4>é—®é¢˜1ï¼šç¯å¢ƒå˜é‡æœªè®¾ç½®</h4>
            <p>åœ¨ Netlify æ§åˆ¶å° â†’ Site settings â†’ Environment variables ä¸­æ·»åŠ ï¼š</p>
            <div class="url-display">PAY_API_KEY = f659709e38ab01a9d77e52cdcda9a914</div>
            
            <h4>é—®é¢˜2ï¼šNetlify Functions æœªéƒ¨ç½²</h4>
            <p>æ£€æŸ¥ netlify/functions/ ç›®å½•ä¸‹æ˜¯å¦æœ‰ payment-callback.js æ–‡ä»¶</p>
            
            <h4>é—®é¢˜3ï¼šé‡å®šå‘è§„åˆ™é—®é¢˜</h4>
            <p>æ£€æŸ¥ netlify.toml ä¸­çš„é‡å®šå‘è§„åˆ™æ˜¯å¦æ­£ç¡®</p>
            
            <h4>é—®é¢˜4ï¼šç­¾åéªŒè¯å¤±è´¥</h4>
            <p>æ£€æŸ¥é€šè®¯å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼Œç­¾åç®—æ³•æ˜¯å¦åŒ¹é…</p>
        </div>
    </div>

    <script>
        const appSecret = 'f659709e38ab01a9d77e52cdcda9a914';
        const baseUrl = 'https://phenomenal-meerkat-53edff.netlify.app';

        function log(message) {
            const logDiv = document.getElementById('diagnosisLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('diagnosisLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        function showResult(title, message, type) {
            const resultDiv = document.getElementById('diagnosisResult');
            resultDiv.innerHTML = `
                <h3>${title}</h3>
                <div class="${type}">
                    <p>${message}</p>
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        async function testBasicConnectivity() {
            log('=== å¼€å§‹æµ‹è¯•åŸºç¡€è¿é€šæ€§ ===');
            
            try {
                // æµ‹è¯•ä¸»ç«™ç‚¹
                log('æµ‹è¯•ä¸»ç«™ç‚¹è¿é€šæ€§...');
                const mainResponse = await fetch(baseUrl);
                if (mainResponse.ok) {
                    log('âœ… ä¸»ç«™ç‚¹è¿é€šæ­£å¸¸');
                } else {
                    log(`âŒ ä¸»ç«™ç‚¹è¿é€šå¤±è´¥: ${mainResponse.status}`);
                }

                // æµ‹è¯•åŒæ­¥å›è°ƒ
                log('æµ‹è¯•åŒæ­¥å›è°ƒè¿é€šæ€§...');
                const syncResponse = await fetch(`${baseUrl}/callback?test=1`);
                log(`åŒæ­¥å›è°ƒå“åº”: ${syncResponse.status} - ${await syncResponse.text()}`);

                // æµ‹è¯•å¼‚æ­¥å›è°ƒ
                log('æµ‹è¯•å¼‚æ­¥å›è°ƒè¿é€šæ€§...');
                const asyncResponse = await fetch(`${baseUrl}/.netlify/functions/payment-callback?test=1`);
                log(`å¼‚æ­¥å›è°ƒå“åº”: ${asyncResponse.status} - ${await asyncResponse.text()}`);

            } catch (error) {
                log(`âŒ è¿é€šæ€§æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testNetlifyFunctions() {
            log('=== å¼€å§‹æµ‹è¯• Netlify Functions ===');
            
            try {
                // æµ‹è¯•åŸºç¡€å‡½æ•°
                const response = await fetch(`${baseUrl}/.netlify/functions/payment-callback`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const responseText = await response.text();
                log(`Netlify Function å“åº”: ${response.status}`);
                log(`å“åº”å†…å®¹: ${responseText}`);
                
                if (response.ok) {
                    log('âœ… Netlify Functions å·¥ä½œæ­£å¸¸');
                } else {
                    log('âŒ Netlify Functions å·¥ä½œå¼‚å¸¸');
                }

            } catch (error) {
                log(`âŒ Netlify Functions æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testCallbackRedirects() {
            log('=== å¼€å§‹æµ‹è¯•å›è°ƒé‡å®šå‘ ===');
            
            try {
                // æµ‹è¯•åŒæ­¥å›è°ƒé‡å®šå‘
                const syncResponse = await fetch(`${baseUrl}/callback`, {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                log(`åŒæ­¥å›è°ƒé‡å®šå‘çŠ¶æ€: ${syncResponse.status}`);
                if (syncResponse.status === 301 || syncResponse.status === 302) {
                    log(`é‡å®šå‘åˆ°: ${syncResponse.headers.get('Location')}`);
                }

                // æµ‹è¯•å¼‚æ­¥å›è°ƒé‡å®šå‘
                const asyncResponse = await fetch(`${baseUrl}/payment-callback`, {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                log(`å¼‚æ­¥å›è°ƒé‡å®šå‘çŠ¶æ€: ${asyncResponse.status}`);
                if (asyncResponse.status === 301 || asyncResponse.status === 302) {
                    log(`é‡å®šå‘åˆ°: ${asyncResponse.headers.get('Location')}`);
                }

            } catch (error) {
                log(`âŒ é‡å®šå‘æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testFullCallbackFlow() {
            log('=== å¼€å§‹æµ‹è¯•å®Œæ•´å›è°ƒæµç¨‹ ===');
            
            const testData = {
                payId: 'DIAGNOSIS_TEST_' + Date.now(),
                param: 'è¯Šæ–­æµ‹è¯•å•†å“',
                type: '1',
                price: '0.01',
                reallyPrice: '0.01'
            };

            // ç”Ÿæˆç­¾å
            const signString = `${testData.payId}${testData.param}${testData.type}${testData.price}${testData.reallyPrice}${appSecret}`;
            const signature = CryptoJS.MD5(signString).toString();
            
            log(`æµ‹è¯•æ•°æ®: ${JSON.stringify(testData)}`);
            log(`ç­¾åå­—ç¬¦ä¸²: ${signString}`);
            log(`è®¡ç®—ç­¾å: ${signature}`);

            try {
                // æµ‹è¯•å¼‚æ­¥å›è°ƒ
                const asyncUrl = `${baseUrl}/.netlify/functions/payment-callback?payId=${testData.payId}&param=${testData.param}&type=${testData.type}&price=${testData.price}&reallyPrice=${testData.reallyPrice}&sign=${signature}`;
                log(`å¼‚æ­¥å›è°ƒURL: ${asyncUrl}`);
                
                const asyncResponse = await fetch(asyncUrl);
                const asyncText = await asyncResponse.text();
                
                log(`å¼‚æ­¥å›è°ƒå“åº”: ${asyncResponse.status} - ${asyncText}`);
                
                if (asyncResponse.ok && asyncText.includes('success')) {
                    log('âœ… å¼‚æ­¥å›è°ƒæµ‹è¯•æˆåŠŸ');
                } else {
                    log('âŒ å¼‚æ­¥å›è°ƒæµ‹è¯•å¤±è´¥');
                }

            } catch (error) {
                log(`âŒ å®Œæ•´å›è°ƒæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function checkEnvironmentVariables() {
            log('=== æ£€æŸ¥ç¯å¢ƒå˜é‡ ===');
            
            try {
                // é€šè¿‡æµ‹è¯•è¯·æ±‚æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
                const response = await fetch(`${baseUrl}/.netlify/functions/payment-callback?env_check=1`);
                const responseText = await response.text();
                
                log(`ç¯å¢ƒå˜é‡æ£€æŸ¥å“åº”: ${response.status} - ${responseText}`);
                
                if (responseText.includes('è­¦å‘Šï¼šä½¿ç”¨ç¡¬ç¼–ç çš„é€šè®¯å¯†é’¥')) {
                    log('âš ï¸ ç¯å¢ƒå˜é‡ PAY_API_KEY æœªæ­£ç¡®è®¾ç½®');
                    showResult('ç¯å¢ƒå˜é‡é—®é¢˜', 'ç¯å¢ƒå˜é‡ PAY_API_KEY æœªæ­£ç¡®è®¾ç½®ï¼Œè¯·æ£€æŸ¥ Netlify æ§åˆ¶å°é…ç½®', 'warning');
                } else {
                    log('âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£å¸¸');
                }

            } catch (error) {
                log(`âŒ ç¯å¢ƒå˜é‡æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹è¯Šæ–­
        window.onload = function() {
            log('å›è°ƒè¯Šæ–­å·¥å…·å·²åŠ è½½');
            log('å¼€å§‹è‡ªåŠ¨è¯Šæ–­...');
            setTimeout(() => {
                testBasicConnectivity();
                setTimeout(() => testNetlifyFunctions(), 2000);
                setTimeout(() => testCallbackRedirects(), 4000);
                setTimeout(() => testFullCallbackFlow(), 6000);
                setTimeout(() => checkEnvironmentVariables(), 8000);
            }, 1000);
        };
    </script>
</body>
</html>
